# name: Release Rust (crates.io)

# on:
#   push:
#     tags:
#       - 'v*'
#   workflow_dispatch:
#     inputs:
#       publish:
#         description: 'Publish to crates.io (true/false)'
#         required: true
#         default: 'false'
#       dry-run:
#         description: 'Dry run (true/false)'
#         required: true
#         default: 'true'

# permissions:
#   contents: read

# jobs:
#   # ============================================================================
#   # Verify and publish to crates.io
#   # ============================================================================
#   publish:
#     name: Publish to crates.io
#     runs-on: ubuntu-latest

#     steps:
#       - uses: actions/checkout@v4

#       - name: Install Rust
#         uses: dtolnay/rust-toolchain@stable

#       - name: Cache cargo registry
#         uses: actions/cache@v4
#         with:
#           path: |
#             ~/.cargo/registry
#             ~/.cargo/git
#           key: ${{ runner.os }}-cargo-publish-${{ hashFiles('**/Cargo.lock') }}

#       - name: Verify package (dry-run)
#         run: |
#           cargo publish -p surgedb-core --dry-run
#         if: github.event.inputs.dry-run == 'true' || !startsWith(github.ref, 'refs/tags/v')

#       - name: Publish surgedb-core
#         if: (startsWith(github.ref, 'refs/tags/v') || github.event.inputs.publish == 'true') && github.event.inputs.dry-run != 'true'
#         run: cargo publish -p surgedb-core --token ${{ secrets.CARGO_REGISTRY_TOKEN }}

#       - name: Wait for crates.io to index
#         if: (startsWith(github.ref, 'refs/tags/v') || github.event.inputs.publish == 'true') && github.event.inputs.dry-run != 'true'
#         run: sleep 30

#       - name: Publish surgedb-server
#         if: (startsWith(github.ref, 'refs/tags/v') || github.event.inputs.publish == 'true') && github.event.inputs.dry-run != 'true'
#         run: cargo publish -p surgedb-server --token ${{ secrets.CARGO_REGISTRY_TOKEN }}

#       - name: Publish surgedb-cli
#         if: (startsWith(github.ref, 'refs/tags/v') || github.event.inputs.publish == 'true') && github.event.inputs.dry-run != 'true'
#         run: cargo publish -p surgedb-cli --token ${{ secrets.CARGO_REGISTRY_TOKEN }}
